# Принцип работы системы (dev) #
## Потоки ##
![ddosdetector](images/dev-scheme.png)

Основной поток демона (**main**) создает несколько видов потоков для разных задач:

* потоки-обработчики пакетов **netmap receiver** (их количество равно количеству rxring очередей сетевой карты);
* поток **watcher**;
* поток **task runner**;
* поток **controld**.

Потоки-обработчики **netmap receiver** создаются по одному на каждую кольцевую очередь (*rxring*) входящих пакетов сетевой карты. Вычисление доступного количества очередей и создание потоков выполняет класс *NetmapReceiver* (файл *collector.hpp*). Каждый поток *netmap receiver*, независимо от других, обрабатывает свои пакеты из своей очереди и проверяет их по отдельной копии правил (класс *RulesCollection* файл *rules.cpp*). Отдельная копия правил для каждого потока позволяет избежать излишних блокировок при проверке пакетов (если сделать одну потокобезопасную версию коллекции правил на все потоки, то пока один поток работает с этой коллекцией, остальные будут ждать). Поток *netmap receiver* только проверяет полученные пакеты по правилам и увеличивает счетчики в своей копии коллекции правил, проверкой триггеров, вычислением дельт счетчиков, выполнением заданий занимаются другие потоки. То есть потоки-обработчики тратят процессорное время только на максимально быстрый разбор пакетов из очередей сетевой карты.

Поток **watcher** (функция *wathcer()* в файле *ddosdetector.cpp*) выполняет несколько задач:

* следит за актуальностью коллекций правил у потоков-обработчиков netmap receiver;
* актуализирует коллекции правил потоков-обработчиков;
* просчитывает дельта-значения счетчиков (байт в секунду, пакетов в секунду);
* проверяет триггеры правил и добавляет задания триггеров в очередь заданий.

Для проверки коллекций потоков-обработчиков, поток watcher работает с вектором содержащим shared_ptr указатели на эти коллекции. Проверка актуальности коллекций правил выполняется раз в секунду. Коллекция правил каждого потока-обработчика сравнивается с эталонной коллекцией и если они различаются, коллекция потока-обработчика обновляется. Также эталонная коллекция используется для хранения суммированных счетчиков со всех потоков-обработчиков, то есть эталонная коллекция содержит актуальные данные по полученному трафику. Просчет дельта-значений выполняется по эталонной коллекции (после того как счетчики были собраны со всех потоков-обработчиков). Далее, также по эталонной коллекции, выполняется проверка триггеров и если какой либо из триггеров сработал, добавляется задание TraggerAction (файл *action.hpp*) в очередь заданий. Сама очередь заданий обрабатывается другим поток - **task runner**.

Поток **task runner** ожидает задания триггера проверяя очередь заданий, как только в очереди появляется задание оно запускается. Задания запускаются фоново, поток не ждет завершения задания.     

Поток **controld** отвечает за консоль управления системой. В этом потоке происходит запуск TCP/UNIX socket сервера. Когда пользователь подключается к консоли и вносит изменения в набора правил, изменения производятся в эталонной коллекции и только через секунду (максимум) синхронизируются по всем потокам-обработчикам.

## Средства синхронизации и разделяемые данные ##
Класс коллекции правил **RulesCollection** (файл *rules.hpp*), содержит набор потокобезопасных списков правил **RulesList** (файл *rules.hpp*), по одному для каждого L4 протокола. Каждый **RulesList** - это public член класса RulesCollection, работа с которым происходит напрямую. Синхронизация работы потоков выполняется на уровне каждого RulesList с помощью boost::shared_mutex. Операции: проверки пакета; обновления счетчиков; проверка триггеров - выполняются сразу со всеми элементами RulesList за одну блокировку мьютекса.

## Файлы ##
Проект имеет следующую файловую структуру
```bash
$ tree
.
├── action.cpp
├── action.hpp
├── collector.cpp
├── collector.hpp
├── controld.cpp
├── controld.hpp
├── ddosdetector.cpp
├── docs
│   ├── EXAMPLE_RULES.md
│   └── INFLUXDB.md
├── exceptions.cpp
├── exceptions.hpp
├── functions.cpp
├── functions.hpp
├── influxdb.cpp
├── influxdb.hpp
├── lib
│   └── queue.hpp
├── Makefile
├── parser.cpp
├── parser.hpp
├── proto
│   ├── baserule.cpp
│   ├── baserule.hpp
│   ├── icmp.cpp
│   ├── icmp.hpp
│   ├── ip.cpp
│   ├── ip.hpp
│   ├── tcp.cpp
│   ├── tcp.hpp
│   ├── udp.cpp
│   └── udp.hpp
├── README.md
├── rules.cpp
├── rules.hpp
├── scripts
│   └── send-dump.py
├── sys
│   └── net
│       ├── netmap.h
│       └── netmap_user.h
└── test
    └── cppcheck_suppress.cfg
```
Подробнее по заголовочным файлам:

* **action.hpp** - классы *Action* и *TriggerJob* отвечающие за задания сработавших триггеров правил, то есть то, что и как будет выполнено когда триггер сработает;
* **collector.hpp** - классы *NetmapPoller* и *NetmapReceiver* отвечают за работу с драйвером netmap, получение и передачу пакетов на проверку по правилам;
* **controld.hpp** - классы *ControlSession<T>* и *ControlServer* отвечающие за консоль управления, создание TCP/UNIX socket сервера, разбор полученных команд;
* **ddosdetector.cpp - основной файл приложения**
* **exceptions.hpp** - классы исключений, вынесены в отдельный файл, чтобы можно было использовать как библиотеку в других модулях, где могут происходить эти исключения;
* **functions.hpp** - набор общих функций (преобразование строк, инициализация лога и т.д.);
* **lib/queue.hpp** - класс *ts_queue<T>* потокобезопасной очереди, используется для организации очереди заданий триггеров
* **parser.hpp** - класс и функции разбора/парсинга команд из консоли управления, или загруженных из файла
* **proto/baserule.hpp** - классы *NumRange<T>*, *NumComparable<T>* и *BaseRule* это базовые классы для создания правил анализа трафика;
* **proto/ip.hpp** - класс *Ipv4Rule* отвечает за параметры правила L3 уровня ipv4 пакета;
* **proto/[icmp,tcp,udp].hpp** - классы параметров протоколов L4 уровня;
* **rules.hpp** - классы *RulesList<T>*, *RulesCollection* и *RulesFileLoader* - это основные классы по работе с правилами проверки трафика, в классе *RulesList<T>* реализована защита разделяемых данных между потоками-получателями пакетов;  
* **sys/** - системные библиотеки для работы с драйвером netmap (взяты из репозитория netmap).
* **docs/** - каталог с документацией
* **influxdb.hpp** - класс *InfluxClient* для работы с базой данных InfluxDB
* **scripts/** - каталог со скриптами, которые могу вызываться системой после срабатывания триггера
